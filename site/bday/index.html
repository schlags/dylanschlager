<!-- Fomantic UI stuff -->
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>DylanSchlager.com | Sam and Dylan's Birthday</title>

        <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.css">
        <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.js"></script>
    </head>
    <body>
        <div class="ui mobile stackable padded grid" id="mainGrid">
            <div class="row">
                <div class="ui attached secondary segment">
                    <div class="ui one column stackable grid">
                        <div class="column">
                                <h3 class="ui header">
                                    <div class="ui right floated animated button" tabindex="0" id="homeButton">
                                        <div class="hidden content">Home</div>
                                        <div class="visible content">
                                        <i class="icon home"></i>
                                        </div>
                                    </div>
                                    <i class="birthday cake icon"></i>
                                    <div class="content">
                                        Dylan and Sam's Birthday Bash
                                        <div class="sub header">
                                            <p>Bar Crawl</p>
                                        </div>
                                    </div>
                                </h3>
                        </div>
                    </div>

                    <div class="ui warning message">
                        <i class="close icon"></i>
                        <div class="header">
                            <div class="ui label">June 25, 2022</div><br />Recent Update:
                            <div class="ui divider"></div>
                        </div>
                        <div class="content">
                            <p>
                                It's HERE! Be prepared for rain.
                            </p>
                            <p>
                                I might change a bar if weather sucks, so check the site regularly.
                            </p>

                            <p>
                                <b>Karlie will deal a card at all bars except Jackson's and the Dinner break.</b>
                            </p>
                        </div>
                    </div>

                    <div class="ui sticky">
                        <div class="ui basic segment">
                            <!-- Register button -->
                            <div class="ui fluid top icon labeled primary huge button" id="registerButton">
                                <i class="user plus icon"></i>
                                <div class="content">
                                    RSVP to the Crawl
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ui segment" id="time">
                        <div class="ui header">When:</div>
                        <div class="ui button" onclick="window.open('assets/dylan-bday.ics')">
                            Add to Calendar
                        </div>
                        <div class="ui large primary tag label">
                            <i class="calendar icon"></i>
                            Saturday, June 25th
                        </div>
                    </div>

                    <div class="ui segment" id="game">
                        <div class="ui header">The Game:</div>
                        <!-- Make card 100% of container -->
                        <div class="ui fluid card">  
                            <div class="image">
                                <div class="ui ribbon red label">NEW!</div>
                              <img src="https://img.freepik.com/free-vector/four-aces-five-card-poker-hand-playing-cards-with-back-design-playing-card-isolated_168129-596.jpg?w=2000">
                            </div>
                            <div class="content">
                              <a class="header">Degenerate Drinkers | Bar Crawl Poker</a>
                              <div class="meta">
                                <span class="date">Details and instructions:</span>
                              </div>
                              <div class="description">
                                <h3 class="ui center aligned icon header">
                                    <i class="ui dice icon"></i>
                                    <div class="content">Upon arrival, you will be handed a card. 
                                        <div class="sub header">
                                            Build the best five card poker hand that you can by the end of the night.
                                            <p>Karlie will act as dealer for this game.</p>
                                        </div>
                                    </div>
                                </h3>
                                <div class="ui secondary segment">
                                    <h3 class="ui center aligned header">
                                        <div class="content">Instructions:</div>
                                    </h4>
                                    <div class="ui divided list">
                                        <div class="item">
                                        <i class="plus square icon"></i>
                                        <div class="content">
                                            <div class="header">Getting More Cards</div>
                                            <div class="description">At selected bars, you will be handed an additional card. 
                                                <p>
                                                    On the day of the crawl, watch the site to see what bars were selected.
                                                </p>
                                                <b>
                                                    You, not Karlie, are responsible for getting your card at the bar.
                                                </b>
                                            </div>
                                        </div>
                                        </div>
                                        <div class="item">
                                            <i class="clipboard list icon"></i>
                                            <div class="content">
                                            <div class="header">Building Your Hand</div>
                                            <div class="description">Just like 7 card poker, use the cards that you have been given to make the best poker hand possible.
                                                <br />  
                                                <b>A poker hand in this game is five cards.</b></div>
                                            <!-- centered button to open modal that shows image -->
                                            </div>
                                            <div class="ui center aligned basic segment">
                                                <div class="ui blue mini button" onclick="$('#pokerModal').modal('show')">
                                                    <i class="info icon"></i>
                                                    Poker Hands Guide for the Noobs
                                                </div>
                                            </div>
                                        </div>
                                        <div class="item">
                                            <i class="glass cheers icon"></i>
                                            <div class="content">
                                            <div class="header">What if I miss a bar?</div>
                                            <div class="description">
                                                You can make up for lost opportunity to get the max of 7 cards by showing yourself taking a SHOT that is 70 proof or higher to Karlie.
                                            </div>
                                            </div>
                                        </div>
                                        <div class="item">
                                            <i class="users icon"></i>
                                            <div class="content">
                                            <div class="header">Cards Available</div>
                                            <div class="description">Since there are a lot of people attending, there will be a ton of decks in use.
                                                <p>For this reason, same number cards of the same suit are possible. These types of hands have higher rank.</p>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="item">
                                            <i class="people arrows icon"></i>
                                            <div class="content">
                                            <div class="header">Trading With Other Degens</div>
                                            <div class="description">It would be unrealistic to expect Karlie and I to enforce that there cannot be trading.
                                                <p><b>So go nuts.</b></p>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="item">
                                            <i class="trophy icon"></i>
                                            <div class="content">
                                            <div class="header">Winning</div>
                                            <div class="description">The winner(s) will get free Red Bull from Matt Bradley.
                                                <p><b>And your drink of choice from Dylan at Jackson's.</b></p>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>
                            <div class="extra content">
                              <a>
                                <i class="info icon"></i>
                                You can only have a max of 7 cards to make your 5 card hand. Scout's honor that you don't cheat and get more. I'll be super sad.
                                <p>
                                    
                                </p>
                                <div class="ui tertiary center aligned segment">
                                    Lost cards will NOT be replaced. You can convince someone else to give you one of their extras.
                                </div>
                              </a>
                            </div>
                        </div>
                    </div>
                    <!-- List Schedule -->
                    <div class="ui segment">
                        <div class="ui header">
                            Schedule:
                        </div>
                        <div class="ui warning message">
                            <i class="close icon"></i>
                            <p>
                                <i class="map icon"></i>
                                Click the address to get directions in Google Maps
                            </p>
                            <p>
                                <i class="clock icon"></i>
                                Schedule items will update as the crawl progresses with
                                where we should be at that time. (Text me to confirm)
                            </p>
                            <!-- This is subject to change message -->
                            <p>
                                <i class="warning icon"></i>
                                <strong>
                                    This schedule is subject to change.
                                </strong>
                            </p>
                        </div>
                        <div class="ui center aligned basic segment">
                            <div class="ui steps" id="scheduleList">
                                <div class="step">
                                    <i class="calendar icon"></i>
                                    <div class="content">
                                        <div class="title">Coming Soon</div>
                                        <div class="description">
                                            <p>
                                                <strong>Starts at 1:00 PM</strong>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ui segment" id="thoseComing">
                        <div class="ui header">
                            <button class="circular ui right floated icon small button" id="refreshAttendees">
                                <i class="icon refresh"></i>
                            </button>
                            <div id="numberOfAttendees"></div>
                        </div>

                        <!-- Attendees list -->
                        <div class="ui center aligned segment">
                            <div class="ui divided relaxed list" id="attendees">
                            </div>
                        </div>
                    </div>
                    <!-- Event RSVP modal -->
                    <div class="ui modal" id="rsvpModal">
                        <i class="close icon"></i>
                        <div class="header">
                        Join the Crawl
                        </div>
                        <div class="image center aligned content">
                        <div class="ui medium image">
                            <img src="images/sam.jpg">
                        </div>
                        <div class="description">
                            <form class="ui form">
                                <div class="inline fields">
                                    <div class="field">
                                        <label>First Name</label>
                                        <input type="text" name="firstName" id="fNameField" placeholder="First">
                                    </div>
                                    <div class="field">
                                        <label>Last Name</label>
                                        <input type="text" name="lastName" id="lNameField" placeholder="Last">
                                    </div>
                                    <div class="field">
                                        <div class="ui checkbox">
                                            <input type="checkbox" id="agame" name="checkbox">
                                            <label>I agree to bring my A-Game</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui error message"></div>
                            </form>
                        </div>
                        </div>
                        <div class="actions">
                        <div class="ui black deny button">
                            Nope, never mind.
                        </div>
                        <div class="ui positive approve right labeled icon button" id="submitFormButton">
                            I'm in
                            <i class="checkmark icon"></i>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Poker modal -->
                    <div class="ui modal" id="pokerModal">
                        <i class="close icon"></i>
                        <div class="header">
                            Poker Hands
                        </div>
                        <div class="image center aligned content">
                            <div class="ui medium image">
                                <img src="https://www.telegraph.co.uk/content/dam/betting/Better-Collective/Poker-hands-sheet.jpg?imwidth=480">
                            </div>
                        </div>
                    </div>

                    <div class="ui top attached error message">
                        FYI - I'm actively developing this site, so it might be fucked up in spots.
                    </div>
                </div>
            </div>
        </div>
    </body>
<script>      


    $('.ui.modal')
    .modal({
        blurring: true,
        onDeny: function () {
            window.alert('What the heck.');
        },
        onApprove: function () {
            var validated = $('.ui.form').form('validate form');
            if(!validated){
                return false;
                window.alert('Not chill.')
            }
        }
    })
    ;

    $('.ui.dropdown')
        .dropdown();

    $('.ui.sticky')
    .sticky({
        context: '#mainGrid'
    })
    ;

    $('#homeButton').click(function() {
        window.location.href = "../index.html";
    });


    $('#registerButton').click(function() {
        $('.ui.modal').modal('show');
    });

    $('#refreshAttendees').click(function() {
        $(".icon.refresh").addClass("loading");
        updateAttendees();
        return new Promise(resolve => {
            setTimeout(() => {
                $(".icon.refresh").removeClass("loading");
                resolve();
            }, 1000);
        });
    })
    $('.message .close')
    .on('click', function() {
        $(this)
        .closest('.message')
        .transition('fade')
        ;
    })
    ;

    $(document).ready(function() {
        updateAttendees();
        updateSchedule();
    });

    $('.ui.form')
    .form({
        fields: {
            fNameField     : 'empty',
            lNameField   : 'empty',
            agame    : 'checked'
        }
    })
    ;

    function updateAttendees() {
        $.get('https://api.dylanschlager.com/birthday/attendees', function(data) {
            if (data) {
                $('#attendees').empty();
                $('#numberOfAttendees').html('Amount Registered:<div class="ui blue inverted label">'+data.body.length+'</div>');
                for (var person in data.body) {
                    $('#attendees').append(
                        '<div class="item">' +
                        '<div class="middle aligned content">' +
                        '<div class="header">' + data.body[person].id + '</div>' +
                        '<div class="description">' +
                        '<div class="ui small basic label">' + getHoursAgo(data.body[person]['Signed Up Time']) + '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>');
                }
            }
        })
    }

    function getHoursAgo(last) {
            var today = new Date();
            var lastJS = new Date(Number(last))
            var hours = Math.abs(today - lastJS) / 36e5;
            var days = hours/24
            var minutes = hours*60
            var seconds = minutes*60
            if (minutes < 1) {
                return parseInt(seconds)+" second(s) ago"
            }
            else if (minutes < 60) {
                return parseInt(minutes)+" minute(s) ago";
            }
            else if (hours < 24) {
                return parseInt(hours)+" hour(s) ago"
            }
            else {
                return parseInt(days)+" day(s) ago"
            }
        }
    
    $('#submitFormButton').click(function() {
        var fName = $('#fNameField').val();
        var lName = $('#lNameField').val();
        addNewAttendee(fName, lName);
    });

    var addNewAttendee = (firstName,lastName)=>{
            if (firstName == "" || lastName == "") {
                var validated = $('.ui.form').form('validate form');
                if(!validated){
                    return;
                }
                console.log("Form validated but still empty values");
                return;
            }
            // instantiate a headers object
            var myHeaders = new Headers();
            // add content type header to object
            myHeaders.append("Content-Type", "application/json");
            // using built in JSON utility package turn object to string and store in a variable
            var raw = JSON.stringify({"firstName":firstName,"lastName":lastName});
            // create a JSON object with parameters for API call and store in a variable
            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
            };
            // make API call with parameters and use promises to get response
            fetch("https://api.dylanschlager.com/birthday/attendees", requestOptions)
            .then(response => response.text())
            .then(result => {
                $('body').toast({
                    position: 'top attached',
                    title: 'Success',
                    class: 'green',
                    message: JSON.parse(result).body
                });
                updateAttendees();
                })
            .catch(error => console.log('error', error));
        }
    
    function returnPlayingCard(barName) {
        if (barName != "DINNER (break)" && barName != "Jackson's (Can't get kicked out again)") {
            console.log("Card valid for bar: " + barName);
            return  '<a class="ui image top right attached yellow label newCard">'+
                    '<img src="images/stack-cards.png">'+
                    'New Card Here!'+
                    '</a>';
        } else {
            console.log("Card invalid for bar: " + barName);
            return  '<a class="ui image top right attached red image label newCard">'+
                    '<img src="images/no-gambling.png">'+
                    'No Card Here!'+
                    '</a>';
        }
    }

    function updateSchedule() {
        $.get('https://api.dylanschlager.com/birthday/schedule', function(data) {
            if (data) {
                $('#scheduleList').empty();
                var numbers = ["one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten"];
                for (var i in data.body) {
                    var number = +i + 1;
                    $('#scheduleList').append(
                        '<div class="step" id="'+encodeURIComponent(data.body[i].id)+'">'+
                        returnPlayingCard(data.body[i].id)+
                        '<div class="ui disabled circular large label">'+number+'</div><br />'+
                        '<div class="content">'+
                        '<div class="title">'+data.body[i].id+'</div>'+
                        '<div class="description">'+
                            '<div class="column">'+
                                '<div class="ui blue inverted basic label">'+data.body[i].arriveTime+'</div><strong>to</strong>'+
                                '<div class="ui red inverted basic label">'+data.body[i].leaveTime+'</div>'+
                            '</div>' +
                        '</div>'+
                        '<div class="ui horizontal divider"></div>'+
                        '<a class="ui label" href="https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(data.body[i].address)+'">'+
                            '<i class="map marker alternate icon"></i>'+data.body[i].address+
                        '</a>'+
                        '</div>');
                    // If the data.body[i].id isn't "Dinner" or "Jacksons", append label to step
                    $('#scheduleList').append('</div>'); 
                     
                        
                }
            }
            // Highlight green when current time matches start time of schedule item
            var today = new Date();
            // Get day of month
            var currentDay = today.getDate();

            console.log("Current Day of Month: ", currentDay);
            var currentTime = new Date();
            new Intl.DateTimeFormat('default',
            {
                hour12: true,
                hour: 'numeric',
                minute: 'numeric'
            }).format(currentTime);
            var currentHour = 0;
            if (currentDay != 25) {
                console.log("Not the 25th, setting currentHour to 0 to prevent active highlighting");
            } else {
                console.log("It's the 25th, setting currentHour to ", currentTime.getHours());
                currentHour = currentTime.getHours();
            }
            //convert to 12 hour time
            if (currentHour > 12) {
                currentHour = currentHour - 12;
            }
            var currentTimeString = currentHour;


            $('.step').each(function() {
                if ($(this).find('.title').text() == "DINNER (break)") {
                    //add light pink background color to css style of step
                    $(this).css("background-color", "#FFECEC");
                }
                if ($(this).find('.title').text() == "Seven Grand") {
                    // add low opacity background image to step
                    $(this).css("background-image", "url('http://sevengrandbars.com/wp-content/uploads/2018/10/%E2%80%A2Edit-0369-1600x1067.jpg')");
                    $(this).css("background-size", "cover");
                    // add box shadow
                    $(this).css("box-shadow", "inset 1000px 1000px 1000px rgba(255,255,255,.7)");
                }
                if ($(this).find('.title').text() == "Jackson's (Can't get kicked out again)") {
                    // add low opacity background image to step
                    $(this).css("background-image", "url('https://i.insider.com/5c09a75f0fefb30c4a52a413?width=1200&format=jpeg')");
                    $(this).css("background-size", "cover");
                    // add box shadow
                    $(this).css("box-shadow", "inset 1000px 1000px 1000px rgba(255,255,255,.7)");
                }
                if ($(this).find('.title').text() == "Lustre Pearl") {
                    // add low opacity background image to step
                    $(this).css("background-image", "url('https://images.squarespace-cdn.com/content/v1/5984a64c37c5816a681b2b29/1511405787874-8WL1KV9FDWV2A0IIAYSH/lpd+banner.JPG?format=2500w')");
                    $(this).css("background-size", "cover");
                    // add box shadow
                    $(this).css("box-shadow", "inset 1000px 1000px 1000px rgba(255,255,255,.8)");
                }
                var that = $(this)
                var startTime = $(this).find('.description').find('.column').find('.ui.blue.inverted.basic.label').text();
                    if (startTime.split(':')[0] == currentTimeString) {
                        console.log("TIME MATCHED, we are at: "+$(this).find('.title').text());
                        that.addClass('active');
                        $(this).find('.ui.circular.label').removeClass('disabled');
                        $(this).find('.ui.circular.label').addClass('green');
                        $(this).find('.ui.circular.label').append('<div class="detail">We Are Here</div>');
                    }
            });
        })
    }

</script>

</html>