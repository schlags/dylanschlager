<!-- Fomantic UI stuff -->
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>DylanSchlager.com | Birthday</title>

        <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.css">
        <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.js"></script>
    </head>
    <body>
        <div class="ui mobile stackable padded grid" id="mainGrid">
            <div class="row">
                <div class="ui attached secondary segment">
                    <div class="ui one column stackable grid">
                        <div class="column">
                                <h3 class="ui header">
                                    <div class="ui right floated animated button" tabindex="0" id="homeButton">
                                        <div class="hidden content">Home</div>
                                        <div class="visible content">
                                        <i class="icon home"></i>
                                        </div>
                                    </div>
                                    <i class="birthday cake icon"></i>
                                    <div class="content">
                                        Dylan's 26th Birthday
                                        <div class="sub header">
                                            <p>Bar Crawl</p>
                                        </div>
                                    </div>
                                </h3>
                        </div>
                    </div>

                    <div class="ui warning message">
                        <i class="close icon"></i>
                        <div class="header">
                            Recent Update:
                            <div class="ui divider"></div>
                        </div>
                        <div class="content">
                            <p>
                                Hey, friends!
                            </p>
                            <p>
                                I was thinking we could all just go nuts in Denver somewhere and celebrate
                                my birthday with a bar crawl. 
                            </p>
                            <p>
                                Sign up here if you can make it! There will probably be a theme, but we'll
                                figure that out later.
                            </p>
                        </div>
                    </div>

                    <div class="ui sticky">
                        <div class="ui basic segment">
                            <!-- Register button -->
                            <div class="ui fluid top icon labeled primary huge button" id="registerButton">
                                <i class="user plus icon"></i>
                                <div class="content">
                                    RSVP to the Crawl
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ui segment" id="time">
                        <div class="ui header">When:</div>
                        <div class="ui button" onclick="window.open('assets/dylan-bday.ics')">
                            Add to Calendar
                        </div>
                        <div class="ui large primary tag label">
                            <i class="calendar icon"></i>
                            Saturday, June 25th
                        </div>
                    </div>

                    <div class="ui segment" id="schedule">
                        <div class="ui header">
                            Schedule:
                        </div>
                        <div class="ui center aligned secondary segment">
                        <div class="ui steps">
                            <div class="step">
                                <i class="calendar icon"></i>
                                <div class="content">
                                    <div class="title">Coming Soon</div>
                                    <div class="description">
                                        <p>
                                            <strong>Starts at 1:00 PM</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        </div>
                    </div>

                    <div class="ui segment" id="thoseComing">
                        <div class="ui header">
                            <button class="circular ui right floated icon small button" id="refreshAttendees">
                                <i class="icon refresh"></i>
                            </button>
                            <div id="numberOfAttendees"></div>
                        </div>

                        <!-- Attendees list -->
                        <div class="ui center aligned segment">
                            <div class="ui divided relaxed list" id="attendees">
                            </div>
                        </div>
                    </div>
                    <!-- Event RSVP modal -->
                    <div class="ui modal" id="rsvpModal">
                        <i class="close icon"></i>
                        <div class="header">
                        Join the Crawl
                        </div>
                        <div class="image center aligned content">
                        <div class="ui medium image">
                            <img src="images/sam.jpg">
                        </div>
                        <div class="description">
                            <form class="ui form">
                                <div class="inline fields">
                                    <div class="field">
                                        <label>First Name</label>
                                        <input type="text" name="firstName" id="fNameField" placeholder="First">
                                    </div>
                                    <div class="field">
                                        <label>Last Name</label>
                                        <input type="text" name="lastName" id="lNameField" placeholder="Last">
                                    </div>
                                    <div class="field">
                                        <div class="ui checkbox">
                                            <input type="checkbox" id="agame" name="checkbox">
                                            <label>I agree to bring my A-Game</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui error message"></div>
                            </form>
                        </div>
                        </div>
                        <div class="actions">
                        <div class="ui black deny button">
                            Nope, never mind.
                        </div>
                        <div class="ui positive approve right labeled icon button" id="submitFormButton">
                            I'm in
                            <i class="checkmark icon"></i>
                        </div>
                        </div>
                    </div>
                    <div class="ui top attached error message">
                        FYI - I'm actively developing this site, so it might be fucked up in spots.
                    </div>
                </div>
            </div>
        </div>
    </body>
<script>      


    $('.ui.modal')
    .modal({
        blurring: true,
        onDeny: function () {
            window.alert('What the heck.');
        },
        onApprove: function () {
            var validated = $('.ui.form').form('validate form');
            if(!validated){
                return false;
                window.alert('Not chill.')
            }
        }
    })
    ;

    $('.ui.dropdown')
        .dropdown();

    $('.ui.sticky')
    .sticky({
        context: '#mainGrid'
    })
    ;

    $('#homeButton').click(function() {
        window.location.href = "../index.html";
    });
    $('#registerButton').click(function() {
        $('.ui.modal').modal('show');
    });

    $('#refreshAttendees').click(function() {
        $(".icon.refresh").addClass("loading");
        updateAttendees();
        return new Promise(resolve => {
            setTimeout(() => {
                $(".icon.refresh").removeClass("loading");
                resolve();
            }, 1000);
        });
    })
    $('.message .close')
    .on('click', function() {
        $(this)
        .closest('.message')
        .transition('fade')
        ;
    })
    ;

    $(document).ready(function() {
        updateAttendees();
    });

    $('.ui.form')
    .form({
        fields: {
            fNameField     : 'empty',
            lNameField   : 'empty',
            agame    : 'checked'
        }
    })
    ;

    function updateAttendees() {
        $.get('https://api.dylanschlager.com/birthday', function(data) {
            console.log(data);
            if (data) {
                $('#attendees').empty();
                $('#numberOfAttendees').html('Amount Registered:<div class="ui blue inverted label">'+data.body.length+'</div>');
                for (var person in data.body) {
                    console.log(person);
                    $('#attendees').append(
                        '<div class="item">' +
                        '<div class="middle aligned content">' +
                        '<div class="header">' + data.body[person].id + '</div>' +
                        '<div class="description">' +
                        '<div class="ui small basic label">' + getHoursAgo(data.body[person]['Signed Up Time']) + '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>');
                }
            }
        })
    }

    function getHoursAgo(last) {
            var today = new Date();
            var lastJS = new Date(Number(last))
            var hours = Math.abs(today - lastJS) / 36e5;
            var days = hours/24
            var minutes = hours*60
            var seconds = minutes*60
            if (minutes < 1) {
                return parseInt(seconds)+" second(s) ago"
            }
            else if (minutes < 60) {
                return parseInt(minutes)+" minute(s) ago";
            }
            else if (hours < 24) {
                return parseInt(hours)+" hour(s) ago"
            }
            else {
                return parseInt(days)+" day(s) ago"
            }
        }
    
    $('#submitFormButton').click(function() {
        var fName = $('#fNameField').val();
        var lName = $('#lNameField').val();
        addNewAttendee(fName, lName);
    });

    var addNewAttendee = (firstName,lastName)=>{
            if (firstName == "" || lastName == "") {
                var validated = $('.ui.form').form('validate form');
                if(!validated){
                    return;
                }
                console.log("Form validated but still empty values");
                return;
            }
            // instantiate a headers object
            var myHeaders = new Headers();
            // add content type header to object
            myHeaders.append("Content-Type", "application/json");
            // using built in JSON utility package turn object to string and store in a variable
            var raw = JSON.stringify({"firstName":firstName,"lastName":lastName});
            // create a JSON object with parameters for API call and store in a variable
            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
            };
            // make API call with parameters and use promises to get response
            fetch("https://api.dylanschlager.com/birthday", requestOptions)
            .then(response => response.text())
            .then(result => {
                $('body').toast({
                    position: 'top attached',
                    title: 'Success',
                    class: 'green',
                    message: JSON.parse(result).body
                });
                updateAttendees();
                })
            .catch(error => console.log('error', error));
        }

</script>

</html>